<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="./modx.prosilver.en.xsl"?>
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.0.1.xsd">
	<header>
		<license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>
    		<title lang="en-gb">phpBB Garage</title>
    		<description lang="en-gb">This mod allows users of your forum to add details about their vehicles.</description>
    		<author-notes lang="en-gb"><![CDATA[- Support is given for both prosilver & subsilver2 templates. Please note the DIY instructions at the end of this file should be completed AFTER the COPY actions and not at the end. Currently the XSL does not allow me place the DIY instructions where I need.
]]></author-notes>

		<author-group>
			<author>
				<realname>Esmond Poynton</realname>
				<email>esmond.poynton[at]gmail[dot]com</email>
				<username>poyntesm</username>
				<homepage>http://forums.phpbbgarage.com/</homepage>
			</author>
		</author-group>

		<mod-version>
			<major>2</major>
			<minor>0</minor>
			<revision>B3</revision>
		</mod-version>

		<installation>
			<level>advanced</level>
			<time>1800</time>
			<target-version>
				<target-primary>3.0.RC3</target-primary>
				<target-major allow="exact">3</target-major>
				<target-minor allow="exact">0</target-minor>
            			<target-revision allow="after-equal" stage="release-candidate">3</target-revision>
			</target-version>
		</installation>

		<history>
			<entry>
        			<date>2007-xx-xx</date>
			        <rev-version>
					<major>2</major>
					<minor>0</minor>
					<revision>B3</revision>
				</rev-version>
				<changelog lang="en-gb">
					<change>Third BETA release.</change>
				</changelog>
			</entry>
			<entry>
        			<date>2007-06-08</date>
			        <rev-version>
					<major>2</major>
					<minor>0</minor>
					<revision>B2</revision>
				</rev-version>
				<changelog lang="en-gb">
					<change>Second BETA release.</change>
				</changelog>
			</entry>
			<entry>
        			<date>2007-05-22</date>
			        <rev-version>
					<major>2</major>
					<minor>0</minor>
					<revision>B1</revision>
				</rev-version>
				<changelog lang="en-gb">
					<change>First phpBB3 version of phpBB Garage for phpBB3.</change>
				</changelog>
			</entry>
		</history>
	</header>

	<action-group>
		<copy>
			<file from="./root/adm/*.*" to="./adm/" />
			<file from="./root/garage/*.*" to="./garage/" />
			<file from="./root/includes/*.*" to="./inculdes/" />
			<file from="./root/language/en/*.*" to="./langauge/en/" />
			<file from="./root/*garage*.*" to="./" />
		</copy>

		<diy-instructions lang="en-gb"><![CDATA[Open your web browser and open the address http://www.yourdomain.com/pathtophpbb/garage/install/
Delete install_garage.php if it ran succesfully]]>
		</diy-instructions>
	    
		<open src="common.php">
			<edit>
				<find><![CDATA[<?php]]></find>
				<action type="after-add">//-- mod : Garage ----------------------------------------------------------------------------------------------------------</action>
			</edit>
			<edit>
				<find><![CDATA[$config = $cache->obtain_config();]]></find>
				<action type="after-add">//-- mod start : Garage ----------------------------------------------------------------------------------------------------
//-- add
require($phpbb_root_path . 'includes/mods/class_garage.' . $phpEx);
//-- mod finish : Garage ---------------------------------------------------------------------------------------------------</action>
			</edit>
		</open>

		<open src="memberlist.php">
			<edit>
				<find><![CDATA[<?php]]></find>
				<action type="after-add">//-- mod : Garage ----------------------------------------------------------------------------------------------------------</action>
			</edit>
			<edit>
				<find><![CDATA['k' => $user->lang['JABBER']]]></find>
				<inline-edit>
					<inline-find><![CDATA['k' => $user->lang['JABBER']]]></inline-find>
					<inline-action type="after-add"><![CDATA[, 'o' => $user->lang['GARAGE']]]></inline-action>
				</inline-edit>
			</edit>
			<edit>
				<find><![CDATA['k' => 'u.user_jabber']]></find>
				<inline-edit>
					<inline-find><![CDATA['k' => 'u.user_jabber']]></inline-find>
					<inline-action type="after-add"><![CDATA[, 'o' => 'u.garage_id']]></inline-action>
				</inline-edit>
			</edit>
			<edit>
				<find><![CDATA[			'SELECT'	=> 'u.user_id, u.group_id as default_group, u.username, u.username_clean, u.user_colour, u.user_rank, u.user_posts, u.user_allow_pm, g.group_id, g.group_name, g.group_colour, g.group_type, ug.user_id as ug_user_id',]]></find>
				<inline-edit>
					<inline-find>ug.user_id as ug_user_id</inline-find>
					<inline-action type="after-add">, v.id as vid</inline-action>
				</inline-edit>
			</edit>
			<edit>
				<find><![CDATA[			),

			'WHERE'		=> $db->sql_in_set('u.user_id', array_unique(array_merge($admin_id_ary, $mod_id_ary)), false, true) . ']]></find>
				<action type="before-add"><![CDATA[				,array(
					'FROM'	=> array(GARAGE_VEHICLES_TABLE => 'v'),
					'ON'	=> 'v.user_id = u.user_id AND v.main_vehicle = 1'
				)]]></action>
			</edit>
			<edit>
				<find>		// Custom Profile Fields
		$profile_fields = array();</find>
				<action type="before-add"><![CDATA[//-- mod start : Garage ----------------------------------------------------------------------------------------------------
//-- add
		if ($garage_config['integrate_profile'])
		{
			include_once($phpbb_root_path . 'includes/mods/class_garage_vehicle.' . $phpEx);
			$garage_vehicle->profile_integration($member['user_id']);
		}
//-- mod finish : Garage ---------------------------------------------------------------------------------------------------]]></action>
			</edit>

			<edit>
				<find><![CDATA[				$sql = 'SELECT *
					FROM ' . USERS_TABLE . '
					WHERE ' . $db->sql_in_set('user_id', $user_list);]]></find>
				<action type="replace-with"><![CDATA[//-- mod start : Garage ----------------------------------------------------------------------------------------------------
//-- modify
				$sql = 'SELECT u.*, v.id as vid
					FROM ' . USERS_TABLE . ' u
					LEFT JOIN ' . GARAGE_VEHICLES_TABLE . ' v
						ON (
							v.user_id = u.user_id AND v.main_vehicle = 1
						)
						WHERE ' . $db->sql_in_set('u.user_id', $user_list);
//-- mod finish : Garage ---------------------------------------------------------------------------------------------------]]></action>
			</edit>

			<edit>
				<find><![CDATA[			'S_SHOW_GROUP'		=> ($mode == 'group') ? true : false,]]></find>
				<action type="before-add"><![CDATA[//-- mod start : Garage ----------------------------------------------------------------------------------------------------
//-- add
			'U_SORT_GARAGE'			=> $pagination_url . '&amp;sk=o&amp;sd=' . (($sort_key == 'o' && $sort_dir == 'a') ? 'd' : 'a'),
			'S_DISPLAY_GARAGE_MEMBERLIST'	=> ($garage_config['integrate_memberlist']) ? true : false,
			'GARAGE_IMG'			=> $user->img('garage_icon_garage', $user->lang['USERS_GARAGE']),
//-- mod finish : Garage ---------------------------------------------------------------------------------------------------]]></action>
			</edit>

			<edit>
				<find><![CDATA[		'U_WWW'			=> (!empty($data['user_website'])) ? $data['user_website'] : '',]]></find>
				<action type="before-add"><![CDATA[//-- mod start : Garage ----------------------------------------------------------------------------------------------------
//-- add
		'U_GARAGE'		=> (!empty($data['vid'])) ? append_sid("{$phpbb_root_path}garage.$phpEx", 'mode=dispay_results&amp;username=' . $data['username']) : '',
//-- mod finish : Garage ---------------------------------------------------------------------------------------------------]]></action>
			</edit>


		</open>
		
		<open src="viewonline.php">
			<edit>
				<find><![CDATA[<?php]]></find>
				<action type="after-add">//-- mod : Garage ----------------------------------------------------------------------------------------------------------</action>
			</edit>
			<edit>
				<find><![CDATA[		case 'report':
			$location = $user->lang['REPORTING_POST'];
			$location_url = append_sid("{$phpbb_root_path}index.$phpEx");
		break;]]></find>
				<action type="after-add"><![CDATA[//-- mod start : Garage ----------------------------------------------------------------------------------------------------
//-- add
		case 'garage':
			$location = $user->lang['GARAGE'];
			$location_url = append_sid("{$phpbb_root_path}index.$phpEx");
		break;

		case 'garage_blog':
			$location = $user->lang['GARAGE_BLOG'];
			$location_url = append_sid("{$phpbb_root_path}index.$phpEx");
		break;

		case 'garage_dynorun':
			$location = $user->lang['GARAGE_DYNORUN'];
			$location_url = append_sid("{$phpbb_root_path}index.$phpEx");
		break;

		case 'garage_guestbook':
			$location = $user->lang['GARAGE_GUESTBOOK'];
			$location_url = append_sid("{$phpbb_root_path}index.$phpEx");
		break;

		case 'garage_modification':
			$location = $user->lang['GARAGE_MODIFICATION'];
			$location_url = append_sid("{$phpbb_root_path}index.$phpEx");
		break;

		case 'garage_premium':
			$location = $user->lang['GARAGE_PREMIUM'];
			$location_url = append_sid("{$phpbb_root_path}index.$phpEx");
		break;

		case 'garage_quartermile':
			$location = $user->lang['GARAGE_QUARTERMILE'];
			$location_url = append_sid("{$phpbb_root_path}index.$phpEx");
		break;

		case 'garage_service':
			$location = $user->lang['GARAGE_SERVICE'];
			$location_url = append_sid("{$phpbb_root_path}index.$phpEx");
		break;

		case 'garage_track':
			$location = $user->lang['GARAGE_TRACK'];
			$location_url = append_sid("{$phpbb_root_path}index.$phpEx");
		break;

		case 'garage_vehicle':
			$location = $user->lang['GARAGE_VEHICLE'];
			$location_url = append_sid("{$phpbb_root_path}index.$phpEx");
		break;
//-- mod finish : Garage ---------------------------------------------------------------------------------------------------]]></action>
			</edit>
		</open>
		
		<open src="viewtopic.php">
			<edit>
				<find><![CDATA[<?php]]></find>
				<action type="after-add">//-- mod : Garage ----------------------------------------------------------------------------------------------------------</action>
			</edit>
			<edit>
				<find><![CDATA[	'WARN_IMG'			=> $user->img('icon_user_warn', 'WARN_USER'),]]></find>
				<action type="after-add"><![CDATA[//-- mod start : Garage ----------------------------------------------------------------------------------------------------
//-- add
	'GARAGE_IMG'			=> $user->img('garage_icon_garage', 'USERS_GARAGE'),
//-- mod finish : Garage ---------------------------------------------------------------------------------------------------]]></action>
			</edit>
			<edit>
				<find><![CDATA[$sql = $db->sql_build_query('SELECT', array(]]></find>
				<action type="before-add">//-- mod start : Garage ----------------------------------------------------------------------------------------------------
//-- modify</action>
			</edit>
			<edit>
				<find><![CDATA[	'SELECT'	=> 'u.*, z.friend, z.foe, p.*',]]></find>
				<inline-edit>
					<inline-find>p.*</inline-find>
					<inline-action type="after-add">, g.id as garage_id, CONCAT_WS(\' \', g.made_year, makes.make, models.model) AS vehicle</inline-action>
				</inline-edit>
			</edit>
			<edit>
				<find><![CDATA[			'ON'	=> 'z.user_id = ' . $user->data['user_id'] . ' AND z.zebra_id = p.poster_id'
		)]]></find>
				<action type="after-add"><![CDATA[		,array(
			'FROM'	=> array(GARAGE_VEHICLES_TABLE => 'g'),
			'ON'	=> 'g.user_id = p.poster_id and g.main_vehicle = 1'
		)
		,array(
			'FROM'	=> array(GARAGE_MAKES_TABLE => 'makes'),
			'ON'	=> 'g.make_id = makes.id and makes.pending = 0'
		)
		,array(
			'FROM'	=> array(GARAGE_MODELS_TABLE => 'models'),
			'ON'	=> 'g.model_id = models.id and models.pending = 0'
		)]]></action>
			</edit>
			<edit>
				<find><![CDATA[	'WHERE'		=> $db->sql_in_set('p.post_id', $post_list) . '
		AND u.user_id = p.poster_id'
));]]></find>
				<action type="after-add">//-- mod finish : Garage ---------------------------------------------------------------------------------------------------</action>
			</edit>
			<edit>
				<find><![CDATA[				'age'				=> '',]]></find>
				<action type="after-add"><![CDATA[//-- mod start : Garage ----------------------------------------------------------------------------------------------------
//-- add
				'vehicle'			=> '',
				'garage_id'			=> '',
//-- mod finish : Garage ---------------------------------------------------------------------------------------------------]]></action>
			</edit>
      			<edit>
				<find><![CDATA[				'age'			=> '',]]></find>
				<action type="after-add"><![CDATA[//-- mod start : Garage ----------------------------------------------------------------------------------------------------
//-- add
				'vehicle'		=> $row['vehicle'],
				'garage_id'		=> $row['garage_id'],
//-- mod finish : Garage ---------------------------------------------------------------------------------------------------]]></action>
			</edit>
			<edit>
				<find>	$postrow = array(</find>
				<action type="after-add"><![CDATA[//-- mod start : Garage ----------------------------------------------------------------------------------------------------
//-- add
		'VEHICLE'			=> $user_cache[$poster_id]['vehicle'],
		'U_VEHICLE'			=> (isset($user_cache[$poster_id]['garage_id'])) ? append_sid("{$phpbb_root_path}garage_vehicle.$phpEx", 'mode=view_vehicle&amp;VID=' . $user_cache[$poster_id]['garage_id']) : '',
		'U_GARAGE'			=> (isset($user_cache[$poster_id]['garage_id'])) ? append_sid("{$phpbb_root_path}garage.$phpEx", 'mode=dispay_results&amp;username=' . $user_cache[$poster_id]['username']) : '',
		'S_DISPLAY_GARAGE_VIEWTOPIC'	=> ($garage_config['integrate_viewtopic']) ? true : false,
//-- mod finish : Garage ---------------------------------------------------------------------------------------------------]]></action>
			</edit>
		</open>
		
		<open src="adm/index.php">
			<edit>
				<find><![CDATA[<?php]]></find>
				<action type="after-add">//-- mod : Garage ----------------------------------------------------------------------------------------------------------</action>
			</edit>
			<edit>
				<find><![CDATA[		'ICON_SYNC_DISABLED'		=> '<img src="' . $phpbb_admin_path . 'images/icon_sync_disabled.gif" alt="' . $user->lang['RESYNC'] . '" title="' . $user->lang['RESYNC'] . '" />',]]></find>
				<action type="after-add"><![CDATA[//-- mod start : Garage ----------------------------------------------------------------------------------------------------
//-- add
		'ICON_APPROVE'			=> '<img src="' . $phpbb_admin_path . 'images/icon_garage_approve.gif" alt="' . $user->lang['APPROVE'] . '" title="' . $user->lang['APPROVE'] . '" />',
		'ICON_APPROVE_DISABLED'		=> '<img src="' . $phpbb_admin_path . 'images/icon_garage_approve_disabled.gif" alt="' . $user->lang['APPROVE'] . '" title="' . $user->lang['APPROVE'] . '" />',
		'ICON_DISAPPROVE'		=> '<img src="' . $phpbb_admin_path . 'images/icon_garage_disapprove.gif" alt="' . $user->lang['DISAPPROVE'] . '" title="' . $user->lang['DISAPPROVE'] . '" />',
		'ICON_DISAPPROVE_DISABLED'	=> '<img src="' . $phpbb_admin_path . 'images/icon_garage_disapprove_disabled.gif" alt="' . $user->lang['DISAPPROVE'] . '" title="' . $user->lang['DISAPPROVE'] . '" />',
//-- mod finish : Garage ----------------------------------------------------------------------------------------------------]]></action>
			</edit>
		</open>
		
		<open src="includes/functions.php">
			<edit>
				<find><![CDATA[<?php]]></find>
				<action type="after-add">//-- mod : Garage ----------------------------------------------------------------------------------------------------------</action>
			</edit>
			<edit>
				<find>	global $db, $config, $template, $SID, $_SID, $user, $auth, $phpEx, $phpbb_root_path;</find>
				<action type="after-add">//-- mod start : Garage ----------------------------------------------------------------------------------------------------
//-- add
	global $garage_config;
//-- mod finish : Garage ---------------------------------------------------------------------------------------------------</action>
			</edit>
			<edit>
				<find><![CDATA[		'U_FAQ'					=> append_sid("{$phpbb_root_path}faq.$phpEx"),]]></find>
				<action type="after-add"><![CDATA[//-- mod start : Garage ----------------------------------------------------------------------------------------------------
//-- add
		'U_GARAGE' 			=> append_sid("{$phpbb_root_path}garage.$phpEx"),
		'U_QUARTERMILE' 		=> append_sid("{$phpbb_root_path}garage.$phpEx", 'mode=quartermile_table'),
		'U_DYNORUN' 			=> append_sid("{$phpbb_root_path}garage.$phpEx", 'mode=dynorun_table'),
		'S_DISPLAY_GARAGE'		=> ($garage_config['enable_garage_header']) ? 1 : 0,
		'S_DISPLAY_QUARTERMILE'		=> ($garage_config['enable_quartermile_header']) ? 1 : 0,
		'S_DISPLAY_DYNORUN'		=> ($garage_config['enable_dynorun_header']) ? 1 : 0,
//-- mod finish : Garage ---------------------------------------------------------------------------------------------------]]></action>
			</edit>
		</open>

		<open src="includes/functions_user.php">
			<edit>
				<find><![CDATA[<?php]]></find>
				<action type="after-add">//-- mod : Garage ----------------------------------------------------------------------------------------------------------</action>
			</edit>
			<edit>
				<find><![CDATA[		set_config('num_users', $config['num_users'] - 1, true);
	}

	$db->sql_transaction('commit');]]></find>
				<action type="after-add"><![CDATA[//-- mod start : Garage ----------------------------------------------------------------------------------------------------
//-- add
	include($phpbb_root_path . 'includes/mods/class_garage_vehicle.' . $phpEx);
	$garage_vehicle->delete_user_vehicles($user_id);
//-- mod finish : Garage ---------------------------------------------------------------------------------------------------]]></action>
			</edit>
		</open>

		<open src="includes/session.php">
			<edit>
				<find><![CDATA[<?php]]></find>
				<action type="after-add">//-- mod : Garage ----------------------------------------------------------------------------------------------------------</action>
			</edit>
			<edit>
				<find><![CDATA[		$this->add_lang($lang_set);
		unset($lang_set);]]></find>
				<action type="after-add"><![CDATA[//-- mod start : Garage ----------------------------------------------------------------------------------------------------
//-- add
		$this->add_lang('mods/garage_common');
//-- mod finish : Garage ---------------------------------------------------------------------------------------------------]]></action>
			</edit>
		</open>
	    
		<open src="includes/acp/acp_styles.php">
			<edit>
				<find><![CDATA[<?php]]></find>
				<action type="after-add">//-- mod : Garage ----------------------------------------------------------------------------------------------------------</action>
			</edit>
			<edit>
				<find>		$user->add_lang('acp/styles');</find>
				<action type="after-add">//-- mod start : Garage ----------------------------------------------------------------------------------------------------
//-- add
		$user->add_lang('mods/garage_style');
//-- mod finish : Garage ---------------------------------------------------------------------------------------------------</action>
			</edit>
			<edit>
				<find>, 'button_topic_new', 'button_topic_reply',</find>
				<action type="after-add">//-- mod start : Garage ----------------------------------------------------------------------------------------------------
//-- add
				'garage_icon_garage', 'garage_main_menu', 'garage_browse', 'garage_search', 'garage_quartermile_table', 'garage_dynorun_table', 'garage_lap_table', 'garage_garage_review', 'garage_shop_review', 'garage_insurance_review', 'garage_create_vehicle', 'garage_edit_vehicle', 'garage_delete_vehicle', 'garage_view_vehicle', 'garage_add_modification', 'garage_add_insurance', 'garage_add_dynorun', 'garage_add_quartermile', 'garage_add_lap', 'garage_add_service', 'garage_main_vehicle', 'garage_no_thumb',
//-- mod finish : Garage ---------------------------------------------------------------------------------------------------</action>
			</edit>
			<edit>
				<find><![CDATA[			'polls'		=> array(
				'poll_left', 'poll_center', 'poll_right',
			),]]></find>
				<action type="after-add"><![CDATA[//-- mod start : Garage ----------------------------------------------------------------------------------------------------
//-- add
			'garage'	=> array(
				'garage_img_attached', 'garage_edit', 'garage_delete', 'garage_toggle',
			),
//-- mod finish : Garage ---------------------------------------------------------------------------------------------------]]></action>
			</edit>
		</open>

	</action-group>
</mod>
